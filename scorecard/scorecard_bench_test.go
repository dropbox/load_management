package scorecard

import (
	"fmt"
	insecure_random "math/rand"
	"testing"
	"time"
)

func BenchmarkScorecard(b *testing.B) {
	b.SetParallelism(16)
	rules := [][]Rule{
		{{"op:*;cat:*", 5}, {"cat:*", 5}, {"dog:*", 5}},
		{{"op:*;cat:*", 10}, {"dog:*", 5}},
		{{"cat:*", 5}, {"dog:*", 5}},
	}
	ops := []string{
		"select",
		"delete",
		"update",
		"insert",
	}
	sc := NewDynamicScorecard(rules[0])
	b.RunParallel(func(pb *testing.PB) {
		for pb.Next() {
			op := ops[insecure_random.Intn(len(ops))]
			cat := insecure_random.Intn(5)
			dog := insecure_random.Intn(10)
			tags := []Tag{Tag("op:" + op), Tag(fmt.Sprintf("cat:%d", cat)), Tag(fmt.Sprintf("dog:%d", dog))}
			info := sc.TrackRequest(tags)
			if info.Tracked {
				time.Sleep(10 * time.Millisecond)
				info.Untrack()
			}
			// 10% of calls reconfigure scorecard
			if insecure_random.Float32() < 0.1 {
				newRules := rules[insecure_random.Intn(len(rules))]
				sc.Reconfigure(newRules)
			}
		}
	})
}

// BenchmarkScorecardGenerate exercises a realistic case where there are many
// tags matching a rule fragment and the production of AxB is costly.
func BenchmarkScorecardGenerate(b *testing.B) {
	sc := NewDynamicScorecard([]Rule{{"op:*;dog:*", 1}, {"op:*;cat:*", 5}, {"cat:*", 5}, {"dog:*", 5}})
	tags := []Tag{
		Tag("op:cat_create_txn"),
		Tag("dog:331"),
		Tag("dog:869"),
		Tag("dog:414"),
		Tag("dog:429"),
		Tag("dog:355"),
		Tag("dog:646"),
		Tag("dog:587"),
		Tag("dog:130"),
		Tag("dog:272"),
		Tag("dog:400"),
		Tag("dog:373"),
		Tag("dog:960"),
		Tag("dog:52"),
		Tag("dog:653"),
		Tag("dog:629"),
		Tag("dog:505"),
		Tag("dog:681"),
		Tag("dog:633"),
		Tag("dog:539"),
		Tag("dog:817"),
		Tag("dog:106"),
		Tag("dog:603"),
		Tag("dog:700"),
		Tag("dog:714"),
		Tag("dog:774"),
		Tag("dog:413"),
		Tag("dog:189"),
		Tag("dog:309"),
		Tag("dog:277"),
		Tag("dog:567"),
		Tag("dog:42"),
		Tag("dog:690"),
		Tag("dog:525"),
		Tag("dog:828"),
		Tag("dog:923"),
		Tag("dog:720"),
		Tag("dog:464"),
		Tag("dog:823"),
		Tag("dog:885"),
		Tag("dog:650"),
		Tag("dog:698"),
		Tag("dog:20"),
		Tag("dog:1010"),
		Tag("dog:593"),
		Tag("dog:131"),
		Tag("dog:121"),
		Tag("dog:318"),
		Tag("dog:805"),
		Tag("dog:22"),
		Tag("dog:972"),
		Tag("dog:920"),
		Tag("dog:640"),
		Tag("dog:147"),
		Tag("dog:228"),
		Tag("dog:585"),
		Tag("dog:531"),
		Tag("dog:668"),
		Tag("dog:645"),
		Tag("dog:7"),
		Tag("dog:265"),
		Tag("dog:227"),
		Tag("dog:808"),
		Tag("dog:334"),
		Tag("dog:493"),
		Tag("dog:910"),
		Tag("dog:744"),
		Tag("dog:1004"),
		Tag("dog:759"),
		Tag("dog:264"),
		Tag("dog:288"),
		Tag("dog:8"),
		Tag("dog:441"),
		Tag("dog:562"),
		Tag("dog:561"),
		Tag("dog:200"),
		Tag("dog:502"),
		Tag("dog:75"),
		Tag("dog:788"),
		Tag("dog:815"),
		Tag("dog:858"),
		Tag("dog:532"),
		Tag("dog:1002"),
		Tag("dog:524"),
		Tag("dog:507"),
		Tag("dog:812"),
		Tag("dog:15"),
		Tag("dog:23"),
		Tag("dog:122"),
		Tag("dog:197"),
		Tag("dog:939"),
		Tag("dog:799"),
		Tag("dog:763"),
		Tag("dog:19"),
		Tag("dog:248"),
		Tag("dog:879"),
		Tag("dog:634"),
		Tag("dog:726"),
		Tag("dog:82"),
		Tag("dog:659"),
		Tag("dog:90"),
		Tag("dog:735"),
		Tag("dog:105"),
		Tag("dog:930"),
		Tag("dog:155"),
		Tag("dog:848"),
		Tag("dog:13"),
		Tag("dog:182"),
		Tag("dog:91"),
		Tag("dog:110"),
		Tag("dog:56"),
		Tag("dog:733"),
		Tag("dog:886"),
		Tag("dog:420"),
		Tag("dog:321"),
		Tag("dog:632"),
		Tag("dog:527"),
		Tag("dog:435"),
		Tag("dog:31"),
		Tag("dog:622"),
		Tag("dog:226"),
		Tag("dog:138"),
		Tag("dog:465"),
		Tag("dog:137"),
		Tag("dog:553"),
		Tag("dog:96"),
		Tag("dog:756"),
		Tag("dog:993"),
		Tag("dog:710"),
		Tag("dog:74"),
		Tag("dog:942"),
		Tag("dog:826"),
		Tag("dog:268"),
		Tag("dog:477"),
		Tag("dog:898"),
		Tag("dog:702"),
		Tag("dog:1000"),
		Tag("dog:597"),
		Tag("dog:541"),
		Tag("dog:44"),
		Tag("dog:202"),
		Tag("dog:849"),
		Tag("dog:635"),
		Tag("dog:570"),
		Tag("dog:142"),
		Tag("dog:686"),
		Tag("dog:1003"),
		Tag("dog:651"),
		Tag("dog:386"),
		Tag("dog:784"),
		Tag("dog:1012"),
		Tag("dog:1005"),
		Tag("dog:417"),
		Tag("dog:933"),
		Tag("dog:461"),
		Tag("dog:749"),
		Tag("dog:589"),
		Tag("dog:2"),
		Tag("dog:900"),
		Tag("dog:956"),
		Tag("dog:902"),
		Tag("dog:119"),
		Tag("dog:352"),
		Tag("dog:855"),
		Tag("dog:1009"),
		Tag("dog:833"),
		Tag("dog:987"),
		Tag("dog:953"),
		Tag("dog:462"),
		Tag("dog:793"),
		Tag("dog:791"),
		Tag("dog:238"),
		Tag("dog:415"),
		Tag("dog:340"),
		Tag("dog:831"),
		Tag("dog:907"),
		Tag("dog:918"),
		Tag("dog:479"),
		Tag("dog:491"),
		Tag("dog:287"),
		Tag("dog:259"),
		Tag("dog:692"),
		Tag("dog:256"),
		Tag("dog:685"),
		Tag("dog:641"),
		Tag("dog:330"),
		Tag("dog:275"),
		Tag("dog:305"),
		Tag("dog:84"),
		Tag("dog:329"),
		Tag("dog:768"),
		Tag("dog:353"),
		Tag("dog:301"),
		Tag("dog:723"),
		Tag("dog:163"),
		Tag("dog:69"),
		Tag("dog:421"),
		Tag("dog:172"),
		Tag("dog:528"),
		Tag("dog:508"),
		Tag("dog:626"),
		Tag("dog:509"),
		Tag("dog:996"),
		Tag("dog:814"),
		Tag("dog:951"),
		Tag("dog:317"),
		Tag("dog:829"),
		Tag("dog:263"),
		Tag("dog:694"),
		Tag("dog:327"),
		Tag("dog:21"),
		Tag("dog:1006"),
		Tag("dog:969"),
		Tag("dog:187"),
		Tag("dog:706"),
		Tag("dog:26"),
		Tag("dog:1007"),
		Tag("dog:62"),
		Tag("dog:437"),
		Tag("dog:250"),
		Tag("dog:866"),
		Tag("dog:760"),
		Tag("dog:546"),
		Tag("dog:432"),
		Tag("dog:649"),
		Tag("dog:165"),
		Tag("dog:4"),
		Tag("dog:28"),
		Tag("dog:92"),
		Tag("dog:906"),
		Tag("dog:365"),
		Tag("dog:179"),
		Tag("dog:783"),
		Tag("dog:778"),
		Tag("dog:810"),
		Tag("dog:125"),
		Tag("dog:76"),
		Tag("dog:116"),
		Tag("dog:797"),
		Tag("dog:683"),
		Tag("dog:990"),
		Tag("dog:792"),
		Tag("dog:927"),
		Tag("dog:602"),
		Tag("dog:864"),
		Tag("dog:481"),
		Tag("dog:378"),
		Tag("dog:284"),
		Tag("dog:705"),
		Tag("dog:995"),
		Tag("dog:46"),
		Tag("dog:842")}
	for i := 0; i < b.N; i++ {
		sc.TrackRequest(tags)
	}

}
